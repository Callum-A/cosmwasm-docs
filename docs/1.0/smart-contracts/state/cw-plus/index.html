<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="search" type="application/opensearchdescription+xml" title="CosmWasm Documentation" href="/opensearch.xml"><title data-react-helmet="true">cw-storage-plus | CosmWasm Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://docs.cosmwasm.com/docs/1.0/smart-contracts/state/cw-plus"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-docs-current"><meta data-react-helmet="true" property="og:title" content="cw-storage-plus | CosmWasm Documentation"><meta data-react-helmet="true" name="description" content="Enhanced Storage Engines for CosmWasm"><meta data-react-helmet="true" property="og:description" content="Enhanced Storage Engines for CosmWasm"><link data-react-helmet="true" rel="icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://docs.cosmwasm.com/docs/1.0/smart-contracts/state/cw-plus"><link data-react-helmet="true" rel="alternate" href="https://docs.cosmwasm.com/docs/1.0/smart-contracts/state/cw-plus" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.cosmwasm.com/fr/docs/1.0/smart-contracts/state/cw-plus" hreflang="fr"><link data-react-helmet="true" rel="alternate" href="https://docs.cosmwasm.com/docs/1.0/smart-contracts/state/cw-plus" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.293cb3ed.css">
<link rel="preload" href="/assets/js/runtime~main.20ba1d0d.js" as="script">
<link rel="preload" href="/assets/js/main.81591e0c.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_aKYr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://docs.cosmwasm.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_dark.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--dark_oUvU"></div></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/1.0/">Docs</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/dev-academy/intro">Dev Academy</a></li><li><a class="dropdown__link" href="/tutorials/hijack-escrow/intro">Tutorials</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">dApps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cw-plus/0.9.0/overview">cw-plus</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link" docspluginid="ecosystem">Ecosystem</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/ecosystem/overview">Overview</a></li><li><a class="dropdown__link" href="/ecosystem/jobs">Jobs</a></li><li><a class="dropdown__link" href="/ecosystem/testnets/build-requirements">Testnets</a></li><li><a class="dropdown__link" href="/ecosystem/hall-of-fame">Hall of Fame</a></li><li><a class="dropdown__link" href="/ecosystem/media/assets">Media</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/docs/1.0/">1.0</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/1.0/smart-contracts/state/cw-plus">1.0</a></li><li><a class="dropdown__link" href="/docs/0.16/">0.16</a></li><li><a class="dropdown__link" href="/docs/0.14/">0.14</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_dNtB"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/1.0/smart-contracts/state/cw-plus" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li><li><a href="/fr/docs/1.0/smart-contracts/state/cw-plus" target="_self" rel="noopener noreferrer" class="dropdown__link">FranÃ§ais</a></li></ul></div><div class="toggle_Pssr toggle_TdHA toggleChecked_cnQY toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" checked="" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div><div class="searchBox_qEbK"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_CW9Y sidebarWithHideableNavbar_FoYL"><a href="https://docs.cosmwasm.com/" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_FJUI"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/logo_dark.svg" alt="CosmWasm" class="themedImage_W2Cr themedImage--dark_oUvU"></a><nav class="menu thin-scrollbar menu_SkdO"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.0/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/1.0/getting-started/intro">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/intro">Your First Contract</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/installation">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/setting-env">Setting Up Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/compile-contract">Downloading and Compiling Contract</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/interact-with-contract">Uploading and Interacting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/getting-started/next-steps">Next Steps</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" href="/docs/1.0/architecture/multichain">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/multichain">What are Multi-Chain Contracts?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/actor">Actor Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/addresses">Names and Addresses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/query">Querying</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/serialization">Serialization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/composition">Contract Composition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/architecture/smart-contracts">Comparison with Solidity Contracts</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" href="/docs/1.0/smart-contracts/contract-semantics">Smart Contracts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/contract-semantics">Contract Semantics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/result-option">Result and Option</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/1.0/smart-contracts/message/message">Message</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_VCh3" aria-current="page" tabindex="0" href="/docs/1.0/smart-contracts/state/cw-plus">State</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/1.0/smart-contracts/state/cw-plus">cw-storage-plus</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/state/simple-state">Simple State</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/state/complex-state">Complex State and Maps</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/entry-points">Entry points</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/query">Query</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/events">Events</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/math">Math</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/compilation">Compilation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/deployment">Deployment</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_VCh3" tabindex="0" href="/docs/1.0/smart-contracts/frontend_app/introduction">Frontend App</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/verify">Verifying Smart Contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/migration">Migration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/code-pinning">Code Pinning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/1.0/smart-contracts/sudo">Sudo Execution</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/1.0/integration">Integration</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_cwdi"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_xORG"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->1.0</span><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>cw-storage-plus</h1><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>Enhanced Storage Engines for CosmWasm</p></div></div><p><strong>Notice</strong></p><p>This has been heavily used in many production-quality contracts and
heavily refined. There is one planned API break, but the code has demonstrated
itself to be stable and powerful. Please feel free to use in your contracts.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="usage-overview">Usage Overview<a class="hash-link" href="#usage-overview" title="Direct link to heading">â€‹</a></h2><p>We introduce two main classes to provide a productive abstraction
on top of <code>cosmwasm_std::Storage</code>. They are <code>Item</code>, which is
a typed wrapper around one database key, providing some helper functions
for interacting with it without dealing with raw bytes. And <code>Map</code>,
which allows you to store multiple unique typed objects under a prefix,
indexed by a simple (<code>&amp;[u8]</code>) or compound (eg. <code>(&amp;[u8], &amp;[u8])</code>) primary key.</p><p>These correspond to the concepts represented in <code>cosmwasm_storage</code> by
<code>Singleton</code> and <code>Bucket</code>, but with a re-designed API and implementation
to require less typing for developers and less gas usage in the contracts.</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="item">Item<a class="hash-link" href="#item" title="Direct link to heading">â€‹</a></h2><p>The usage of an <a href="/docs/1.0/smart-contracts/state/src/item.rs"><code>Item</code></a> is pretty straight-forward.
You must simply provide the proper type, as well as a database key not
used by any other item. Then it will provide you with a nice interface
to interact with such data.</p><p>If you are coming from using <code>Singleton</code>, the biggest change is that
we no longer store <code>Storage</code> inside, meaning we don&#x27;t need read and write
variants of the object, just one type. Furthermore, we use <code>const fn</code>
to create the <code>Item</code>, allowing it to be defined as a global compile-time
constant rather than a function that must be constructed each time,
which saves gas as well as typing.</p><p>Example Usage:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Serialize, Deserialize, PartialEq, Debug)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct Config {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub owner: String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub max_tokens: i32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// note const constructor rather than 2 functions with Singleton</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const CONFIG: Item&lt;Config&gt; = Item::new(&quot;config&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn demo() -&gt; StdResult&lt;()&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut store = MockStorage::new();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // may_load returns Option&lt;T&gt;, so None if data is missing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // load returns T and Err(StdError::NotFound{}) if data is missing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = CONFIG.may_load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let cfg = Config {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        owner: &quot;admin&quot;.to_string(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        max_tokens: 1234,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CONFIG.save(&amp;mut store, &amp;cfg)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = CONFIG.load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(cfg, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // update an item with a closure (includes read and write)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // returns the newly saved value</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let output = CONFIG.update(&amp;mut store, |mut c| -&gt; StdResult&lt;_&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        c.max_tokens *= 2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(c)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    })?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(2468, output.max_tokens);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // you can error in an update and nothing is saved</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let failed = CONFIG.update(&amp;mut store, |_| -&gt; StdResult&lt;_&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Err(StdError::generic_err(&quot;failure mode&quot;))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert!(failed.is_err());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // loading data will show the first update was saved</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = CONFIG.load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let expected = Config {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        owner: &quot;admin&quot;.to_string(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        max_tokens: 2468,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(expected, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // we can remove data as well</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    CONFIG.remove(&amp;mut store);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = CONFIG.may_load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="map">Map<a class="hash-link" href="#map" title="Direct link to heading">â€‹</a></h2><p>The usage of an <a href="/docs/1.0/smart-contracts/state/src/item.rs"><code>Map</code></a> is a little more complex, but
is still pretty straight-forward. You can imagine it as a storage-backed
<code>BTreeMap</code>, allowing key-value lookups with typed values. In addition,
we support not only simple binary keys (<code>&amp;[u8]</code>), but tuples, which are
combined. This allows us to store allowances as composite keys
eg. <code>(owner, spender)</code> to look up the balance.</p><p>Beyond direct lookups, we have a super power not found in Ethereum -
iteration. That&#x27;s right, you can list all items in a <code>Map</code>, or only
part of them. We can efficiently allow pagination over these items as
well, starting at the point the last query ended, with low gas costs.
This requires the <code>iterator</code> feature to be enabled in <code>cw-storage-plus</code>
(which automatically enables it in <code>cosmwasm-std</code> as well, and which is
enabled by default).</p><p>If you are coming from using <code>Bucket</code>, the biggest change is that
we no longer store <code>Storage</code> inside, meaning we don&#x27;t need read and write
variants of the object, just one type. Furthermore, we use <code>const fn</code>
to create the <code>Bucket</code>, allowing it to be defined as a global compile-time
constant rather than a function that must be constructed each time,
which saves gas as well as typing. In addition, the composite indexes
(tuples) is more ergonomic and expressive of intention, and the range
interface has been improved.</p><p>Here is an example with normal (simple) keys:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Serialize, Deserialize, PartialEq, Debug, Clone)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub name: String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub age: i32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const PEOPLE: Map&lt;&amp;str, Data&gt; = Map::new(&quot;people&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn demo() -&gt; StdResult&lt;()&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut store = MockStorage::new();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let data = Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &quot;John&quot;.to_string(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        age: 32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // load and save with extra key argument</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = PEOPLE.may_load(&amp;store, &quot;john&quot;)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    PEOPLE.save(&amp;mut store, &quot;john&quot;, &amp;data)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = PEOPLE.load(&amp;store, &quot;john&quot;)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(data, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // nothing on another key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let missing = PEOPLE.may_load(&amp;store, &quot;jack&quot;)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, missing);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // update function for new or existing keys</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let birthday = |d: Option&lt;Data&gt;| -&gt; StdResult&lt;Data&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        match d {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Some(one) =&gt; Ok(Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                name: one.name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                age: one.age + 1,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            None =&gt; Ok(Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                name: &quot;Newborn&quot;.to_string(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                age: 0,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            }),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let old_john = PEOPLE.update(&amp;mut store, &quot;john&quot;, birthday)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(33, old_john.age);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(&quot;John&quot;, old_john.name.as_str());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let new_jack = PEOPLE.update(&amp;mut store, &quot;jack&quot;, birthday)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(0, new_jack.age);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(&quot;Newborn&quot;, new_jack.name.as_str());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // update also changes the store</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(old_john, PEOPLE.load(&amp;store, &quot;john&quot;)?);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(new_jack, PEOPLE.load(&amp;store, &quot;jack&quot;)?);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // removing leaves us empty</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    PEOPLE.remove(&amp;mut store, &quot;john&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = PEOPLE.may_load(&amp;store, &quot;john&quot;)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="key-types">Key types<a class="hash-link" href="#key-types" title="Direct link to heading">â€‹</a></h3><p>A <code>Map</code> key can be anything that implements the <code>PrimaryKey</code> trait. There are a series of implementations of
<code>PrimaryKey</code> already provided (see <code>packages/storage-plus/src/keys.rs</code>):</p><ul><li><code>impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for &amp;&#x27;a [u8]</code></li><li><code>impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for &amp;&#x27;a str</code></li><li><code>impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for Vec&lt;u8&gt;</code></li><li><code>impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for String</code></li><li><code>impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for Addr</code></li><li><code>impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for &amp;&#x27;a Addr</code></li><li><code>impl&lt;&#x27;a, T: PrimaryKey&lt;&#x27;a&gt; + Prefixer&lt;&#x27;a&gt;, U: PrimaryKey&lt;&#x27;a&gt;&gt; PrimaryKey&lt;&#x27;a&gt; for (T, U)</code></li><li><code>impl&lt;&#x27;a, T: PrimaryKey&lt;&#x27;a&gt; + Prefixer&lt;&#x27;a&gt;, U: PrimaryKey&lt;&#x27;a&gt; + Prefixer&lt;&#x27;a&gt;, V: PrimaryKey&lt;&#x27;a&gt;&gt; PrimaryKey&lt;&#x27;a&gt; for (T, U, V)</code></li><li><code>impl&lt;&#x27;a, T: Endian + Clone&gt; PrimaryKey&lt;&#x27;a&gt; for IntKey&lt;T&gt;</code></li></ul><p>That means that byte and string slices, byte vectors, and strings, can be conveniently used as keys.
Moreover, some other types can be used as well, like addresses and address references, pairs and triples, and
integer types.</p><p>If the key represents an address, we suggest using <code>&amp;Addr</code> for keys in storage, instead of <code>String</code> or string slices.
This implies doing address validation through <code>addr_validate</code> on any address passed in via a message, to ensure it&#x27;s a
legitimate address, and not random text which will fail later.
<code>pub fn addr_validate(&amp;self, &amp;str) -&gt; Addr</code> in <code>deps.api</code> can be used for address validation, and the returned <code>Addr</code>
can then be conveniently used as key in a <code>Map</code> or similar structure.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="composite-keys">Composite Keys<a class="hash-link" href="#composite-keys" title="Direct link to heading">â€‹</a></h3><p>There are times when we want to use multiple items as a key, for example, when
storing allowances based on account owner and spender. We could try to manually
concatenate them before calling, but that can lead to overlap, and is a bit
low-level for us. Also, by explicitly separating the keys, we can easily provide
helpers to do range queries over a prefix, such as &quot;show me all allowances for
one owner&quot; (first part of the composite key). Just like you&#x27;d expect from your
favorite database.</p><p>Here how we use it with composite keys. Just define a tuple as a key and use that
everywhere you used a byte slice above.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Note the tuple for primary key. We support one slice, or a 2 or 3-tuple</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// adding longer tuples is quite easy but unlikely to be needed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const ALLOWANCE: Map&lt;(&amp;str, &amp;str), u64&gt; = Map::new(&quot;allow&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn demo() -&gt; StdResult&lt;()&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut store = MockStorage::new();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // save and load on a composite key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = ALLOWANCE.may_load(&amp;store, (&quot;owner&quot;, &quot;spender&quot;))?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ALLOWANCE.save(&amp;mut store, (&quot;owner&quot;, &quot;spender&quot;), &amp;777)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = ALLOWANCE.load(&amp;store, (&quot;owner&quot;, &quot;spender&quot;))?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(777, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // doesn&#x27;t appear under other key (even if a concat would be the same)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let different = ALLOWANCE.may_load(&amp;store, (&quot;owners&quot;, &quot;pender&quot;)).unwrap();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, different);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // simple update</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ALLOWANCE.update(&amp;mut store, (&quot;owner&quot;, &quot;spender&quot;), |v| {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Ok(v.unwrap_or_default() + 222)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    })?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = ALLOWANCE.load(&amp;store, (&quot;owner&quot;, &quot;spender&quot;))?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(999, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="path">Path<a class="hash-link" href="#path" title="Direct link to heading">â€‹</a></h3><p>Under the scenes, we create a <code>Path</code> from the <code>Map</code> when accessing a key.
<code>PEOPLE.load(&amp;store, b&quot;jack&quot;) == PEOPLE.key(b&quot;jack&quot;).load()</code>.
<code>Map.key()</code> returns a <code>Path</code>, which has the same interface as <code>Item</code>,
reusing the calculated path to this key.</p><p>For simple keys, this is just a bit less typing and a bit less gas if you
use the same key for many calls. However, for composite keys, like
<code>(b&quot;owner&quot;, b&quot;spender&quot;)</code> it is <strong>much</strong> less typing. And highly recommended anywhere
you will use a composite key even twice:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Serialize, Deserialize, PartialEq, Debug, Clone)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub name: String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub age: i32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const PEOPLE: Map&lt;&amp;str, Data&gt; = Map::new(&quot;people&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const ALLOWANCE: Map&lt;(&amp;str, &amp;str), u64&gt; = Map::new(&quot;allow&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn demo() -&gt; StdResult&lt;()&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut store = MockStorage::new();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let data = Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: &quot;John&quot;.to_string(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        age: 32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // create a Path one time to use below</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let john = PEOPLE.key(&quot;john&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Use this just like an Item above</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = john.may_load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    john.save(&amp;mut store, &amp;data)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = john.load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(data, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    john.remove(&amp;mut store);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let empty = john.may_load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(None, empty);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Same for composite keys, just use both parts in key().</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Notice how much less verbose than the above example.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let allow = ALLOWANCE.key((&quot;owner&quot;, &quot;spender&quot;));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allow.save(&amp;mut store, &amp;1234)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = allow.load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(1234, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    allow.update(&amp;mut store, |x| Ok(x.unwrap_or_default() * 2))?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let loaded = allow.load(&amp;store)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(2468, loaded);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prefix">Prefix<a class="hash-link" href="#prefix" title="Direct link to heading">â€‹</a></h3><p>In addition to getting one particular item out of a map, we can iterate over the map
(or a subset of the map). This let us answer questions like &quot;show me all tokens&quot;,
and we provide some nice <code>Bound</code>s helpers to easily allow pagination or custom ranges.</p><p>The general format is to get a <code>Prefix</code> by calling <code>map.prefix(k)</code>, where <code>k</code> is exactly
one less item than the normal key (If <code>map.key()</code> took <code>(&amp;[u8], &amp;[u8])</code>, then <code>map.prefix()</code> takes <code>&amp;[u8]</code>.
If <code>map.key()</code> took <code>&amp;[u8]</code>, <code>map.prefix()</code> takes <code>()</code>). Once we have a prefix space, we can iterate
over all items with <code>range(store, min, max, order)</code>. It supports <code>Order::Ascending</code> or <code>Order::Descending</code>.
<code>min</code> is the lower bound and <code>max</code> is the higher bound.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Copy, Clone, Debug)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum Bound {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Inclusive(Vec&lt;u8&gt;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Exclusive(Vec&lt;u8&gt;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    None,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If the <code>min</code> and <code>max</code> bounds, it will return all items under this prefix. You can use <code>.take(n)</code> to
limit the results to <code>n</code> items and start doing pagination. You can also set the <code>min</code> bound to
eg. <code>Bound::Exclusive(last_value)</code> to start iterating over all items <em>after</em> the last value. Combined with
<code>take</code>, we easily have pagination support. You can also use <code>Bound::Inclusive(x)</code> when you want to include any
perfect matches. To better understand the API, please read the following example:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Serialize, Deserialize, PartialEq, Debug, Clone)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">struct Data {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub name: String,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    pub age: i32,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const PEOPLE: Map&lt;&amp;str, Data&gt; = Map::new(&quot;people&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">const ALLOWANCE: Map&lt;(&amp;str, &amp;str), u64&gt; = Map::new(&quot;allow&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fn demo() -&gt; StdResult&lt;()&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut store = MockStorage::new();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // save and load on two keys</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let data = Data { name: &quot;John&quot;.to_string(), age: 32 };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    PEOPLE.save(&amp;mut store, &quot;john&quot;, &amp;data)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let data2 = Data { name: &quot;Jim&quot;.to_string(), age: 44 };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    PEOPLE.save(&amp;mut store, &quot;jim&quot;, &amp;data2)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // iterate over them all</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let all: StdResult&lt;Vec&lt;_&gt;&gt; = PEOPLE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .range(&amp;store, Bound::None, Bound::None, Order::Ascending)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        all?,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        vec![(&quot;jim&quot;.to_vec(), data2), (&quot;john&quot;.to_vec(), data.clone())]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // or just show what is after jim</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let all: StdResult&lt;Vec&lt;_&gt;&gt; = PEOPLE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .range(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &amp;store,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Bound::Exclusive(&quot;jim&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Bound::None,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Order::Ascending,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(all?, vec![(&quot;john&quot;.to_vec(), data)]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // save and load on three keys, one under different owner</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ALLOWANCE.save(&amp;mut store, (&quot;owner&quot;, &quot;spender&quot;), &amp;1000)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ALLOWANCE.save(&amp;mut store, (&quot;owner&quot;, &quot;spender2&quot;), &amp;3000)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ALLOWANCE.save(&amp;mut store, (&quot;owner2&quot;, &quot;spender&quot;), &amp;5000)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // get all under one key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let all: StdResult&lt;Vec&lt;_&gt;&gt; = ALLOWANCE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .prefix(&quot;owner&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .range(&amp;store, Bound::None, Bound::None, Order::Ascending)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        all?,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        vec![(&quot;spender&quot;.to_vec(), 1000), (&quot;spender2&quot;.to_vec(), 3000)]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // Or ranges between two items (even reverse)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let all: StdResult&lt;Vec&lt;_&gt;&gt; = ALLOWANCE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .prefix(&quot;owner&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .range(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &amp;store,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Bound::Exclusive(&quot;spender1&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Bound::Inclusive(&quot;spender2&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Order::Descending,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    assert_eq!(all?, vec![(&quot;spender2&quot;.to_vec(), 3000)]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="indexedmap">IndexedMap<a class="hash-link" href="#indexedmap" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s sue one example of <code>IndexedMap</code> definition and usage, originally taken from the <code>cw721-base</code> contract.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="definition">Definition<a class="hash-link" href="#definition" title="Direct link to heading">â€‹</a></h3><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct TokenIndexes&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pub owner: MultiIndex&lt;&#x27;a, Addr, TokenInfo&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl&lt;&#x27;a&gt; IndexList&lt;TokenInfo&gt; for TokenIndexes&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fn get_indexes(&amp;&#x27;_ self) -&gt; Box&lt;dyn Iterator&lt;Item = &amp;&#x27;_ dyn Index&lt;TokenInfo&gt;&gt; + &#x27;_&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let v: Vec&lt;&amp;dyn Index&lt;TokenInfo&gt;&gt; = vec![&amp;self.owner];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    Box::new(v.into_iter())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn tokens&lt;&#x27;a&gt;() -&gt; IndexedMap&lt;&#x27;a, &amp;&#x27;a str, TokenInfo, TokenIndexes&lt;&#x27;a&gt;&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  let indexes = TokenIndexes {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    owner: MultiIndex::new(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      |d: &amp;TokenInfo| d.owner.clone(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;tokens&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;tokens__owner&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IndexedMap::new(&quot;tokens&quot;, indexes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Let&#x27;s discuss this piece by piece:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct TokenIndexes&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pub owner: MultiIndex&lt;&#x27;a, Addr, TokenInfo, String&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>These are the index definitions. Here there&#x27;s only one index, called <code>owner</code>. There could be more, as public
members of the <code>TokenIndexes</code> struct.</p><p>We see that the <code>owner</code> index is a <code>MultiIndex</code>. A multi-index can have repeated values as keys. The primary key is
used internally as the last element of the multi-index key, to disambiguate repeated index values.
Like the name implies, this is an index over tokens, by owner. Given that an owner can have multiple tokens,
we need a <code>MultiIndex</code> to be able to list / iterate over all the tokens a given owner has.</p><p>The <code>TokenInfo</code> data will originally be stored by <code>token_id</code> (which is a string value).
You can see this in the token creation code:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tokens().update(deps.storage, &amp;msg.token_id, |old| match old {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Some(_) =&gt; Err(ContractError::Claimed {}),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        None =&gt; Ok(token),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    })?;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>(Incidentally, this is using <code>update</code> instead of <code>save</code>, to avoid overwriting an already existing token).</p><p>Given that <code>token_id</code> is a string value, we specify <code>String</code> as the last argument of the <code>MultiIndex</code> definition.
That way, the deserialization of the primary key will be done to the right type (an owned string).</p><p>Then, this <code>TokenInfo</code> data will be indexed by token <code>owner</code> (which is an <code>Addr</code>). So that we can list all the tokens
an owner has. That&#x27;s why the <code>owner</code> index key is <code>Addr</code>.</p><p>Other important thing here is that the key (and its components, in the case of a composite key) must implement
the <code>PrimaryKey</code> trait. You can see that <code>Addr</code> do implement <code>PrimaryKey</code>:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl&lt;&#x27;a&gt; PrimaryKey&lt;&#x27;a&gt; for Addr {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  type Prefix = ();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  type SubPrefix = ();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  type Suffix = Self;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  type SuperSuffix = Self;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fn key(&amp;self) -&gt; Vec&lt;Key&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    // this is simple, we don&#x27;t add more prefixes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    vec![Key::Ref(self.as_bytes())]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><hr><p>We can now see how it all works, taking a look at the remaining code:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">impl&lt;&#x27;a&gt; IndexList&lt;TokenInfo&gt; for TokenIndexes&lt;&#x27;a&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fn get_indexes(&amp;&#x27;_ self) -&gt; Box&lt;dyn Iterator&lt;Item = &amp;&#x27;_ dyn Index&lt;TokenInfo&gt;&gt; + &#x27;_&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        let v: Vec&lt;&amp;dyn Index&lt;TokenInfo&gt;&gt; = vec![&amp;self.owner];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        Box::new(v.into_iter())</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This implements the <code>IndexList</code> trait for <code>TokenIndexes</code>.
Note: this code is more or less boiler-plate, and needed for the internals. Do not try to customize this;
just return a list of all indexes.
Implementing this trait serves two purposes (which are really one and the same): it allows the indexes
to be queried through <code>get_indexes</code>, and, it allows <code>TokenIndexes</code> to be treated as an <code>IndexList</code>. So that
it can be passed as a parameter during <code>IndexedMap</code> construction, below:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn tokens&lt;&#x27;a&gt;() -&gt; IndexedMap&lt;&#x27;a, &amp;&#x27;a str, TokenInfo, TokenIndexes&lt;&#x27;a&gt;&gt; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let indexes = TokenIndexes {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        owner: MultiIndex::new(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            |d: &amp;TokenInfo| d.owner.clone(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;tokens&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &quot;tokens__owner&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        ),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexedMap::new(&quot;tokens&quot;, indexes)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here <code>tokens()</code> is just a helper function, that simplifies the <code>IndexedMap</code> construction for us. First the
index (es) is (are) created, and then, the <code>IndexedMap</code> is created and returned.</p><p>During index creation, we must supply an index function per index</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">        owner: MultiIndex::new(|d: &amp;TokenInfo| d.owner.clone(),</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>, which is the one that will take the value of the original map, and create the index key from it.
Of course, this requires that the elements required for the index key are present in the value.
Besides the index function, we must also supply the namespace of the pk, and the one for the new index.</p><hr><p>After that, we just create and return the <code>IndexedMap</code>:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    IndexedMap::new(&quot;tokens&quot;, indexes)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here of course, the namespace of the pk must match the one used during index(es) creation. And, we pass our
<code>TokenIndexes</code> (as an <code>IndexList</code>-type parameter) as second argument. Connecting in this way the underlying <code>Map</code>
for the pk, with the defined indexes.</p><p>So, <code>IndexedMap</code> (and the other <code>Indexed*</code> types) is just a wrapper / extension around <code>Map</code>, that provides
a number of index functions and namespaces to create indexes over the original <code>Map</code> data. It also implements
calling these index functions during value storage / update / removal, so that you can forget about it,
and just use the indexed data.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="usage">Usage<a class="hash-link" href="#usage" title="Direct link to heading">â€‹</a></h3><p>An example of use, where <code>owner</code> is a <code>String</code> value passed as a parameter, and <code>start_after</code> and <code>limit</code> optionally
define the pagination range:</p><p>Notice this uses <code>prefix()</code>, explained above in the <code>Map</code> section.</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let limit = limit.unwrap_or(DEFAULT_LIMIT).min(MAX_LIMIT) as usize;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let start = start_after.map(Bound::exclusive);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let owner_addr = deps.api.addr_validate(&amp;owner)?;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let res: Result&lt;Vec&lt;_&gt;, _&gt; = tokens()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .idx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .owner</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .prefix(owner_addr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .range(deps.storage, start, None, Order::Ascending)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .take(limit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let tokens = res?;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now <code>tokens</code> contains <code>(token_id, TokenInfo)</code> pairs for the given <code>owner</code>.
The pk values are <code>Vec&lt;u8&gt;</code> in the case of <code>prefix</code> + <code>range</code>, but will be deserialized to the proper type using
<code>prefix_de</code> + <code>range_de</code>; provided that the (optional) pk deserialization type (<code>String</code>, in this case)
is specified in the <code>MultiIndex</code> definition (see #Index keys deserialization, below).</p><p>Another example that is similar, but returning only the <code>token_id</code>s, using the <code>keys()</code> method:</p><div class="codeBlockContainer_I0IT language-rust theme-code-block"><div class="codeBlockContent_wNvx rust"><pre tabindex="0" class="prism-code language-rust codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    let pks: Vec&lt;_&gt; = tokens()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .idx</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .owner</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .prefix(owner_addr)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .keys(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            deps.storage,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            start,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            None,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            Order::Ascending,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .take(limit)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        .collect();</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Now <code>pks</code> contains <code>token_id</code> values (as raw <code>Vec&lt;u8&gt;</code>s) for the given <code>owner</code>. Again, by using <code>prefix_de</code> + <code>range_de</code>,
a deserialized key can be obtained instead, as detailed in the next section.</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="index-keys-deserialization">Index keys deserialization<a class="hash-link" href="#index-keys-deserialization" title="Direct link to heading">â€‹</a></h3><p>For <code>UniqueIndex</code> and <code>MultiIndex</code>, the primary key (<code>PK</code>) type needs to be specified, in order to deserialize
the primary key to it. This generic type comes with a default of <code>()</code>, which means that no deserialization / data
will be provided for the primary key. This is for backwards compatibility with the current <code>UniqueIndex</code> / <code>MultiIndex</code>
impls. It can also come in handy in cases you don&#x27;t need the primary key, and are interested only in the deserialized
values.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/InterWasm/docs/edit/main/docs/04-smart-contracts/03-state/01-cw-plus.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/1.0/smart-contracts/message/submessage"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Submessages</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/1.0/smart-contracts/state/simple-state"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Simple State</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#usage-overview" class="table-of-contents__link toc-highlight">Usage Overview</a></li><li><a href="#item" class="table-of-contents__link toc-highlight">Item</a></li><li><a href="#map" class="table-of-contents__link toc-highlight">Map</a><ul><li><a href="#key-types" class="table-of-contents__link toc-highlight">Key types</a></li><li><a href="#composite-keys" class="table-of-contents__link toc-highlight">Composite Keys</a></li><li><a href="#path" class="table-of-contents__link toc-highlight">Path</a></li><li><a href="#prefix" class="table-of-contents__link toc-highlight">Prefix</a></li></ul></li><li><a href="#indexedmap" class="table-of-contents__link toc-highlight">IndexedMap</a><ul><li><a href="#definition" class="table-of-contents__link toc-highlight">Definition</a></li><li><a href="#usage" class="table-of-contents__link toc-highlight">Usage</a></li><li><a href="#index-keys-deserialization" class="table-of-contents__link toc-highlight">Index keys deserialization</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Related Documentation</div><ul class="footer__items"><li class="footer__item"><a href="https://cosmos.network/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Cosmos SDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://hub.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Cosmos Hub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docs.tendermint.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Tendermint Core<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Repositories</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/CosmWasm/cosmwasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CosmWasm/cosmwasm<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/CosmWasm/wasmd" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CosmWasm/wasmd<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/CosmWasm/cw-plus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>CosmWasm/cw-plus<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/InterWasm/cw-contracts" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InterWasm/cw-contracts<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/InterWasm/cw-awesome" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InterWasm/cw-awesome<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://medium.com/cosmwasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://docs.cosmwasm.com/chat/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/CosmWasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/InterWasm" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>InterWasm<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://cosmwasm.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_RC3H"><img src="/img/logo_stacked.png" alt="CosmWasm Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/logo_stacked.png" alt="CosmWasm Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 CosmWasm</div></div></div></footer></div>
<script src="/assets/js/runtime~main.20ba1d0d.js"></script>
<script src="/assets/js/main.81591e0c.js"></script>
</body>
</html>